name: Daily Bets (RETIRED â€” replaced by nightly-pipeline.yml)

on:
  # RETIRED: Bet placement now handled by nightly-pipeline.yml
  # which also runs data collection and the projection engine.
  # Keeping workflow_dispatch for emergency fallback only.
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-bets:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: betting-engine

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check for NBA games today
        id: check-games
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          python -c "
          import requests, os, sys
          key = os.environ.get('ODDS_API_KEY', '')
          if not key:
              print('No API key, skipping game check')
              sys.exit(0)
          r = requests.get(
              'https://api.the-odds-api.com/v4/sports/basketball_nba/odds',
              params={'apiKey': key, 'regions': 'us', 'markets': 'h2h'},
              timeout=15
          )
          games = r.json() if r.status_code == 200 else []
          if not games:
              print('No NBA games today')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('has_games=false\n')
          else:
              print(f'{len(games)} NBA games today')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('has_games=true\n')
          "

      - name: Run bet placer (sportsbook + Kalshi)
        if: steps.check-games.outputs.has_games != 'false'
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          KALSHI_API_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID }}
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
        run: |
          python src/bet_placer.py
          echo "Generating Polymarket demo/fake bets (read-only)..."
          python src/polymarket_ingestion.py --fetch-markets || true
          python src/polymarket_ev_calculator.py || true
          python src/bet_slip.py --source polymarket-demo || true

      - name: Commit bet slips and master CSV
        if: steps.check-games.outputs.has_games != 'false'
        run: |
          cd ..
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          DATE=$(date +%Y-%m-%d)
          git add betting-engine/data/bet_slips/ betting-engine/data/bet_slips_enhanced/ betting-engine/data/bets/ betting-engine/data/kalshi/bet_slips/ betting-engine/data/polymarket/ betting-engine/data/reports/ || true
          git diff --cached --quiet && echo "No new bet slip to commit" && exit 0
          git commit -m "bets: ${DATE} daily bet slip (sportsbook + Kalshi + Polymarket demo)"
          git push
