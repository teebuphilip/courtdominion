name: Daily Grading

on:
  schedule:
    # 11am ET = 16:00 UTC (EST) / 15:00 UTC (EDT)
    - cron: '0 16 * * *'
  workflow_dispatch:
    inputs:
      date:
        description: 'Date to grade (YYYY-MM-DD). Defaults to yesterday.'
        required: false

permissions:
  contents: write

jobs:
  grade-bets:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: betting-engine

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create required directories
        run: mkdir -p logs

      - name: Determine date to grade
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            echo "grade_date=${{ github.event.inputs.date }}" >> $GITHUB_OUTPUT
          else
            echo "grade_date=$(date -d 'yesterday' +%Y-%m-%d 2>/dev/null || date -v-1d +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

      - name: Check for bet slip
        id: check-slip
        run: |
          DATE="${{ steps.date.outputs.grade_date }}"
          SB_SLIP="data/bet_slips/${DATE}.json"
          K_SLIP="data/kalshi/bet_slips/${DATE}_kalshi.json"
          E_SLIP="data/bet_slips_enhanced/${DATE}.json"
          if [ -f "$SB_SLIP" ] || [ -f "$K_SLIP" ] || [ -f "$E_SLIP" ]; then
            echo "has_slip=true" >> $GITHUB_OUTPUT
            echo "Found bet slip(s) for ${DATE}"
          else
            echo "has_slip=false" >> $GITHUB_OUTPUT
            echo "No bet slips for ${DATE}, skipping"
          fi

      - name: Fetch closing lines (CLV)
        if: steps.check-slip.outputs.has_slip == 'true'
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          KALSHI_API_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID }}
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
        run: |
          python src/clv_fetcher.py --date ${{ steps.date.outputs.grade_date }}

      - name: Grade bets
        if: steps.check-slip.outputs.has_slip == 'true'
        run: |
          python src/result_checker.py --date ${{ steps.date.outputs.grade_date }}

      - name: Commit results, ledger, CSV, and season summary
        if: steps.check-slip.outputs.has_slip == 'true'
        run: |
          cd ..
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          DATE="${{ steps.date.outputs.grade_date }}"
          git add betting-engine/data/results/ betting-engine/data/results_enhanced/ betting-engine/data/ledger.json betting-engine/data/ledger_enhanced.json betting-engine/data/ledger_history.md betting-engine/data/ledger_history_enhanced.md betting-engine/data/bets/ betting-engine/reports/ betting-engine/data/bet_slips_enhanced/ || true
          git diff --cached --quiet && echo "No grading changes to commit" && exit 0
          git commit -m "results: ${DATE} grading + ledger + CSV + season summary"
          git push

  build-historical-bet-page:
    needs: grade-bets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Pull latest branch changes
        run: |
          git fetch origin ${{ github.ref_name }}
          git pull --ff-only origin ${{ github.ref_name }}

      - name: Build fancy static bet pages
        run: |
          python scripts/generate_bet_pages.py

      - name: Upload historical page artifact
        uses: actions/upload-artifact@v4
        with:
          name: historical-bets-page
          path: |
            reports/web/index.html
            reports/web/history_data.json

  build-todays-bet-page:
    needs: grade-bets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Pull latest branch changes
        run: |
          git fetch origin ${{ github.ref_name }}
          git pull --ff-only origin ${{ github.ref_name }}

      - name: Build fancy static bet pages
        run: |
          python scripts/generate_bet_pages.py

      - name: Upload today's page artifact
        uses: actions/upload-artifact@v4
        with:
          name: todays-bets-page
          path: |
            reports/web/today.html
            reports/web/today_data.json

  sync-free-site-pages:
    needs:
      - build-historical-bet-page
      - build-todays-bet-page
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Download historical page artifact
        uses: actions/download-artifact@v4
        with:
          name: historical-bets-page
          path: reports/web

      - name: Download today's page artifact
        uses: actions/download-artifact@v4
        with:
          name: todays-bets-page
          path: reports/web

      - name: Copy generated pages into free-site
        run: |
          mkdir -p free-site/public
          cp reports/web/index.html free-site/public/historical-bets.html
          cp reports/web/today.html free-site/public/todays-bets.html
          cp reports/web/history_data.json free-site/public/history_data.json
          cp reports/web/today_data.json free-site/public/today_data.json

      - name: Commit generated bet pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add reports/web/ free-site/public/historical-bets.html free-site/public/todays-bets.html free-site/public/history_data.json free-site/public/today_data.json || true
          git diff --cached --quiet && echo "No report page changes to commit" && exit 0
          DATE=$(date +%Y-%m-%d)
          git commit -m "reports: ${DATE} sync historical + today's bet pages to free-site"
          git push
