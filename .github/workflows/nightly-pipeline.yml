name: Nightly Pipeline (Legacy Manual)

on:
  workflow_dispatch:
    inputs:
      season:
        description: 'Season to collect (e.g. 2024-25). Defaults to current.'
        required: false
      skip_collection:
        description: 'Skip NBA data collection (use committed data only)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  collect-project-bet:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbb2-engine dependencies
        run: pip install -r dbb2-engine/requirements.txt

      - name: Install betting-engine dependencies
        run: pip install -r betting-engine/requirements.txt

      - name: Create required directories
        run: |
          mkdir -p betting-engine/logs
          mkdir -p betting-engine/data/projections
          mkdir -p betting-engine/data/bet_slips
          mkdir -p betting-engine/data/bets
          mkdir -p betting-engine/data/kalshi/bet_slips
          mkdir -p betting-engine/data/polymarket/markets
          mkdir -p betting-engine/data/polymarket/odds
          mkdir -p betting-engine/data/polymarket/bet_slips
          mkdir -p betting-engine/data/polymarket/fake_positions
          mkdir -p dbb2-engine/raw_data

      - name: Determine current NBA season
        id: season
        run: |
          if [ -n "${{ github.event.inputs.season }}" ]; then
            echo "season=${{ github.event.inputs.season }}" >> $GITHUB_OUTPUT
          else
            MONTH=$(date +%-m)
            YEAR=$(date +%Y)
            if [ "$MONTH" -ge 10 ]; then
              START=$YEAR
              END=$(( YEAR + 1 ))
            else
              START=$(( YEAR - 1 ))
              END=$YEAR
            fi
            SHORT_END=$(printf '%02d' $(( END % 100 )))
            echo "season=${START}-${SHORT_END}" >> $GITHUB_OUTPUT
          fi

      - name: Prepare raw_data directory
        run: |
          mkdir -p dbb2-engine/raw_data
          cp dbb2-engine/data_collection/historical/*.csv dbb2-engine/raw_data/
          echo "Copied historical CSVs to raw_data/"
          ls -lh dbb2-engine/raw_data/

      - name: Collect current season data
        if: github.event.inputs.skip_collection != 'true'
        continue-on-error: true
        run: |
          SEASON="${{ steps.season.outputs.season }}"
          echo "Collecting season: ${SEASON}"
          cd dbb2-engine

          for attempt in 1 2 3; do
            echo "Attempt ${attempt}/3..."
            python data_collection/collect_nba_season.py \
              --season "$SEASON" \
              --output raw_data/ && break
            echo "Attempt ${attempt} failed, waiting 30s..."
            sleep 30
          done

          echo "raw_data/ contents after collection:"
          ls -lh raw_data/

      - name: Run DBB2 projection engine
        run: |
          cd dbb2-engine
          python run_engine.py --game-day
          echo "Engine output:"
          ls -lh output/

      - name: Copy projections to betting engine
        id: projections
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          mkdir -p betting-engine/data/projections
          mkdir -p betting-engine/data/risk
          cp dbb2-engine/output/betting_contract.json \
            betting-engine/data/projections/${DATE}.json
          cp dbb2-engine/output/risk.json \
            betting-engine/data/risk/${DATE}.json
          echo "Copied betting_contract.json -> data/projections/${DATE}.json"

      - name: Check for NBA games today
        id: check-games
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          if [ -z "$ODDS_API_KEY" ]; then
            echo "No ODDS_API_KEY set â€” assuming games today (fail open)"
            echo "has_games=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          python -c "
          import requests, os, sys
          key = os.environ['ODDS_API_KEY']
          r = requests.get(
              'https://api.the-odds-api.com/v4/sports/basketball_nba/odds',
              params={'apiKey': key, 'regions': 'us', 'markets': 'h2h'},
              timeout=15
          )
          games = r.json() if r.status_code == 200 else []
          if not games:
              print('No NBA games today')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('has_games=false\n')
          else:
              print(f'{len(games)} NBA games today')
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write('has_games=true\n')
          "

      - name: Run bet placer
        if: steps.check-games.outputs.has_games != 'false'
        env:
          ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
          KALSHI_API_KEY_ID: ${{ secrets.KALSHI_API_KEY_ID }}
          KALSHI_PRIVATE_KEY: ${{ secrets.KALSHI_PRIVATE_KEY }}
        working-directory: betting-engine
        run: |
          DATE="${{ steps.projections.outputs.date }}"
          PROJ_FILE="data/projections/${DATE}.json"
          if [ ! -f "$PROJ_FILE" ]; then
            echo "No projection file found at ${PROJ_FILE}, skipping"
            exit 0
          fi
          python src/bet_placer.py --from-file "$PROJ_FILE"
          echo "Generating Polymarket demo/fake bets (read-only)..."
          python src/polymarket_ingestion.py --fetch-markets || true
          python src/polymarket_ev_calculator.py || true
          python src/bet_slip.py --source polymarket-demo || true

      - name: Commit projections and bet slips
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          DATE="${{ steps.projections.outputs.date }}"
          BRANCH="${GITHUB_REF_NAME}"

          [ -d dbb2-engine/output ] && git add -f dbb2-engine/output || true
          [ -d betting-engine/data/projections ] && git add -f betting-engine/data/projections || true
          [ -d betting-engine/data/risk ] && git add -f betting-engine/data/risk || true
          [ -d betting-engine/data/bet_slips ] && git add -f betting-engine/data/bet_slips || true
          [ -d betting-engine/data/bet_slips_enhanced ] && git add -f betting-engine/data/bet_slips_enhanced || true
          [ -d betting-engine/data/bets ] && git add -f betting-engine/data/bets || true
          [ -d betting-engine/data/kalshi/bet_slips ] && git add -f betting-engine/data/kalshi/bet_slips || true
          [ -d betting-engine/data/polymarket ] && git add -f betting-engine/data/polymarket || true
          [ -d betting-engine/data/reports ] && git add -f betting-engine/data/reports || true
          [ -d betting-engine/data/private ] && git add -f betting-engine/data/private || true

          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "pipeline: ${DATE} projections + bets"
          git pull --rebase origin "$BRANCH"
          for attempt in 1 2 3; do
            if git push origin "HEAD:${BRANCH}"; then
              exit 0
            fi
            if [ "$attempt" -eq 3 ]; then
              echo "Push failed after 3 attempts"
              exit 1
            fi
            sleep 2
            git pull --rebase origin "$BRANCH"
          done
