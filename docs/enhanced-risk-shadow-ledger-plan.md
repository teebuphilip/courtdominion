# Enhanced Risk + Shadow Ledger Plan

## Objective

Add an **enhanced risk profile** to betting decisions without breaking the current pipeline, and run both modes in parallel so results can be compared directly.

## Key Requirements

- Keep current betting behavior fully intact by default.
- Introduce enhanced risk calculations as a second path.
- Record baseline and enhanced outcomes separately.
- Never place extra real bets because of shadow mode.
- Produce side-by-side reporting to evaluate whether enhanced risk should be promoted.

## Current State Summary

- `betting-engine` currently consumes projections contract (`data/projections/YYYY-MM-DD.json`).
- `risk.json` is generated by `dbb2-engine` but not consumed by `betting-engine`.
- `dbb2-engine` now emits both:
  - existing risk fields (`injury_risk`, `volatility`, `minutes_risk`)
  - enhanced fields (`availability_risk`, `role_risk`, `composition_risk`, `total_risk`, `risk_level`)

## Proposed Design

### 1. Dual Risk Modes

Add config mode:

- `risk_overlay.mode: off | observe | enforce`

Behavior:

- `off`: current behavior only.
- `observe`: compute enhanced decisions and sizing, but do not affect real placed bets.
- `enforce`: enhanced decisions affect filtering/sizing for real pipeline.

### 2. Baseline vs Enhanced Path

For each candidate bet:

- Baseline path: current EV + confidence + Kelly flow.
- Enhanced path: applies risk overlay using enhanced risk profile.

Recommended enhanced inputs:

- `total_risk` primary
- fallback to legacy risk ints when needed
- `risk_level` for categorical gates

### 3. Shadow Ledger (A/B)

Keep baseline ledger unchanged and write enhanced path to separate files.

Suggested files:

- `betting-engine/data/ledger.json` (baseline; existing)
- `betting-engine/data/ledger_history.md` (baseline; existing)
- `betting-engine/data/ledger_enhanced.json` (new)
- `betting-engine/data/ledger_history_enhanced.md` (new)

Optional parallel artifacts:

- `betting-engine/data/bet_slips_enhanced/`
- `betting-engine/data/results_enhanced/`

### 4. Stable Cross-Link ID

Add a deterministic `decision_id` for every bet in both modes:

- Example key material:
  - `date`
  - `player_name`
  - `prop_type`
  - `line`
  - `direction`

Purpose:

- Enables one-to-one baseline/enhanced comparison.
- Makes delta reports deterministic.

### 5. Risk Overlay Mechanics (Enhanced Path)

Keep original formulas unchanged; apply overlay only in enhanced path.

Suggested controls:

- Qualification haircut:
  - increase min edge as risk rises
- Confidence haircut:
  - reduce effective confidence by risk factor
- Kelly haircut:
  - scale units down by risk factor
- Hard guards:
  - optional reject for extreme risk (e.g., high `availability_risk` / `risk_level=High`)

All controls must be parameterized in config.

## Rollout Plan

### Phase 1: Observe Only

- Enable `risk_overlay.mode=observe`.
- Compute enhanced decisions and write shadow ledger.
- Do not alter real placed bets.

Deliverables:

- Enhanced ledger artifacts.
- Daily comparison report.

### Phase 2: Soft Sizing

- Keep qualification same as baseline.
- Apply enhanced risk only to unit sizing in enhanced path.
- Continue shadow run and compare outcomes.

### Phase 3: Full Enforce (Optional)

- Apply enhanced filtering + sizing to live path.
- Keep shadow reporting available for audit.

## Comparison Reporting

Produce daily and cumulative metrics:

- Baseline vs enhanced:
  - bet count
  - units staked
  - win rate
  - ROI
  - max drawdown
  - P/L volatility
- Delta analysis:
  - bets dropped by enhanced risk
  - bets added by enhanced risk
  - shared bets with size changes
  - top reasons (risk gates/haircuts)

## Safety & Guardrails

- Shadow mode must be non-executing (bookkeeping/reporting only).
- Missing risk file should fail open in baseline path, with warning.
- Enhanced path should also fail safely (skip risk overlay, log reason).
- No destructive changes to existing ledger files.

## Suggested Next-Day Task Order

1. Add config flags and default `observe`.
2. Load/normalize risk input for betting-engine.
3. Add enhanced path calculation in memory.
4. Add shadow ledger writers + `decision_id`.
5. Add comparison report generation.
6. Run dry-run validation on historical sample days.
7. Review metrics and tune thresholds.

## Acceptance Criteria

- Existing baseline pipeline behavior remains unchanged with `mode=off`.
- In `observe`, both ledgers are produced with comparable records.
- Reports clearly show baseline vs enhanced deltas.
- Team can decide promotion based on measured outcomes, not intuition.
